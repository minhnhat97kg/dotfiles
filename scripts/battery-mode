#!/usr/bin/env bash
# Battery mode switcher for nix-on-droid
# Makes it easy to switch between full and lite configurations

set -euo pipefail

DOTFILES="$HOME/dotfiles"

show_usage() {
    cat <<EOF
Battery Mode Manager for nix-on-droid

Usage:
  battery-mode status          Show current mode and running services
  battery-mode lite            Switch to battery-optimized mode
  battery-mode full            Switch to full development mode
  battery-mode stop-all        Stop all battery-draining services
  battery-mode dev <shell>     Activate development shell

Examples:
  battery-mode lite            # Switch to lite mode
  battery-mode stop-all        # Stop SSH tunnels and other services
  battery-mode dev go          # Activate Go development shell

Available dev shells:
  go, rust, java, database, web, full
EOF
}

show_status() {
    echo "=== Current Configuration ==="
    if [ -L "$HOME/.nix-profile" ]; then
        # Try to detect which config by checking package count
        local pkg_count=$(nix-env -q | wc -l)
        if [ "$pkg_count" -lt 30 ]; then
            echo "Mode: LITE (battery-optimized)"
        else
            echo "Mode: FULL (all packages)"
        fi
        echo "Packages installed: $pkg_count"
    else
        echo "Unable to detect configuration"
    fi

    echo ""
    echo "=== Running Services ==="

    # Check SSH tunnels
    if pgrep -f "ssh-tunnel" >/dev/null 2>&1; then
        echo "SSH Tunnels: RUNNING ⚠️"
        pgrep -af "ssh-tunnel" | sed 's/^/  /'
    else
        echo "SSH Tunnels: stopped ✓"
    fi

    # Check SSH server
    if pgrep -f "sshd -f" >/dev/null 2>&1; then
        echo "SSH Server: RUNNING"
    else
        echo "SSH Server: stopped"
    fi

    echo ""
    echo "=== Battery Recommendations ==="
    local warnings=0

    if pgrep -f "ssh-tunnel" >/dev/null 2>&1; then
        echo "⚠️  SSH tunnels are running - run 'battery-mode stop-all' to stop"
        warnings=$((warnings + 1))
    fi

    if [ "$warnings" -eq 0 ]; then
        echo "✓ No battery drain detected"
    fi
}

switch_to_lite() {
    echo "Switching to battery-optimized mode..."
    echo "This will remove heavy development tools from the system."
    echo "You can still use them via: dev-go, dev-rust, dev-db, etc."
    echo ""
    read -p "Continue? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi

    nix-on-droid switch --flake "$DOTFILES#lite"
    echo ""
    echo "✓ Switched to lite mode"
    echo ""
    echo "Development tools are now available via devShells:"
    echo "  dev-go, dev-rust, dev-java, dev-db, dev-web, dev-full"
}

switch_to_full() {
    echo "Switching to full development mode..."
    echo "This will install all development tools permanently."
    echo ""
    read -p "Continue? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi

    nix-on-droid switch --flake "$DOTFILES#default"
    echo ""
    echo "✓ Switched to full mode"
}

stop_all() {
    echo "Stopping battery-draining services..."

    # Stop SSH tunnels
    if pgrep -f "ssh-tunnel" >/dev/null 2>&1; then
        pkill -f "ssh-tunnel" && echo "✓ Stopped SSH tunnels"
    else
        echo "  SSH tunnels not running"
    fi

    # Optionally stop SSH server
    if pgrep -f "sshd -f" >/dev/null 2>&1; then
        read -p "Stop SSH server too? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            "$HOME/.ssh/stop-sshd.sh" 2>/dev/null && echo "✓ Stopped SSH server"
        fi
    fi

    echo ""
    echo "✓ Battery-draining services stopped"
}

activate_dev_shell() {
    local shell="$1"

    case "$shell" in
        go|rust|java|database|web|full)
            echo "Activating $shell development shell..."
            nix develop "$DOTFILES#$shell"
            ;;
        *)
            echo "Unknown shell: $shell"
            echo "Available: go, rust, java, database, web, full"
            exit 1
            ;;
    esac
}

# Main
case "${1:-}" in
    status|"")
        show_status
        ;;
    lite)
        switch_to_lite
        ;;
    full)
        switch_to_full
        ;;
    stop-all|stop)
        stop_all
        ;;
    dev)
        if [ $# -lt 2 ]; then
            echo "Usage: battery-mode dev <shell>"
            echo "Available shells: go, rust, java, database, web, full"
            exit 1
        fi
        activate_dev_shell "$2"
        ;;
    help|-h|--help)
        show_usage
        ;;
    *)
        echo "Unknown command: $1"
        show_usage
        exit 1
        ;;
esac
